{% extends "base.twig" %}

{% block title %}Profile - {{ site_name }}{% endblock %}

{% set active_tab = 'profile' %}

{% set profile_nav %}
<nav class="profile-nav">
    <a href="/profile" class="profile-nav-link{{ active_tab == 'profile' ? ' active' : '' }}">Profile</a>
    <a href="/link" class="profile-nav-link{{ active_tab == 'link' ? ' active' : '' }}">Link Account</a>
    <a href="/profile/password" class="profile-nav-link{{ active_tab == 'password' ? ' active' : '' }}">Change Password</a>
</nav>
{% endset %}

{% block content %}
<div class="auth-page">
    <div class="auth-container" style="max-width: 700px;">
        {{ profile_nav }}

        <div class="profile-header">
            <div class="profile-avatar">
                {{ account.email|first|upper }}
            </div>
            <div class="profile-info">
                <h1>{{ account.email }}</h1>
                <div class="profile-meta">Registered {{ account.created_at }}</div>
            </div>
        </div>

        {% if player %}
            <div class="profile-linked">
                <h2>Linked Game Account</h2>
                <div class="linked-info">
                    <div class="linked-item">
                        <div class="linked-label">Username</div>
                        <div class="linked-value">{{ player.username }}</div>
                    </div>
                    <div class="linked-item">
                        <div class="linked-label">UUID</div>
                        <div class="linked-value" style="font-size: 0.8rem; font-family: var(--font-mono);">{{ player.uuid }}</div>
                    </div>
                    <div class="linked-item">
                        <div class="linked-label">Honor Rank</div>
                        <div class="linked-value">{{ player.honor_rank }}</div>
                    </div>
                    <div class="linked-item">
                        <div class="linked-label">Arena Points</div>
                        <div class="linked-value">{{ player.arena_points }}</div>
                    </div>
                </div>
                <div style="margin-top: var(--space-xl);">
                    <a href="/player/{{ player.username }}" class="btn btn-primary">View Public Stats</a>
                </div>
            </div>

            <div class="profile-seasons">
                <h2>Seasons</h2>

                {% if season_success %}
                    <div class="alert alert-success">{{ season_success }}</div>
                {% endif %}
                {% if season_error %}
                    <div class="alert alert-danger">{{ season_error }}</div>
                {% endif %}

                <div class="season-join-card">
                    <h3>Join a Private Season</h3>
                    <form action="/profile/season/join" method="post" class="season-join-form">
                        <input type="text" name="code" class="code-input" placeholder="Enter code" maxlength="20" required>
                        <button type="submit" class="btn btn-primary">Join</button>
                    </form>
                </div>

                <div class="season-list">
                    <h3>Your Private Seasons</h3>
                    {% if private_seasons is empty %}
                        <p class="text-muted">You haven't joined any private seasons yet.</p>
                    {% else %}
                        {% for season in private_seasons %}
                            <div class="season-item">
                                <div class="season-item-info">
                                    {% if season.visibility != 'private' %}
                                        <a href="/seasons/{{ season.slug }}" class="season-item-name">{{ season.name }}</a>
                                    {% else %}
                                        <span class="season-item-name">{{ season.name }}</span>
                                    {% endif %}
                                    <span class="season-item-date">Joined {{ season.joined_at|date('M j, Y') }}</span>
                                </div>
                                <form action="/profile/season/opt-out" method="post" onsubmit="return confirm('You won\'t be able to rejoin this season. Are you sure?');">
                                    <input type="hidden" name="season_id" value="{{ season.id }}">
                                    <button type="submit" class="btn btn-sm btn-danger">Leave</button>
                                </form>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        {% else %}
            <div class="alert alert-info">
                Your account is not linked to a game account yet.
                <a href="/link" style="color: inherit; font-weight: 600;">Link your account</a> to view your stats.
            </div>

            <div class="profile-seasons">
                <h2>Seasons</h2>
                <div class="alert alert-info">
                    You must first <a href="/link" style="color: inherit; font-weight: 600;">link your character</a> to join seasons.
                </div>
            </div>
        {% endif %}

        <div class="auth-footer" style="margin-top: var(--space-xl);">
            <a href="/logout">Logout</a>
        </div>
    </div>
</div>
{% endblock %}
